#!/usr/bin/env python3
import subprocess
import time
import sidraCore

processes = ["cam", "reader", "mass", "lidar", "mcp", "xmit"]
BASE_DIR = "/var/sidra/bin"
SLEEP_SECONDS = 0.5

for driverXmit in sidraCore.driversXmit:
	processes.append(driverXmit)
	
for driverServer in sidraCore.driversServer:
	processes.append(driverServer)

#############################
def runPkill(signalOption):
	for name in processes:
		pattern = f"{BASE_DIR}/{name}"
		try:
			subprocess.run(
				["pkill", signalOption, "-f", pattern],
				stdout=subprocess.DEVNULL,
				stderr=subprocess.DEVNULL,
				check=False,
			)
		except Exception as e:
			print(f"Error running pkill for {pattern}: {e}", flush=True)


#############################
def main():
	# Try graceful shutdown first (SIGINT so mass can do gpio notify off)
	runPkill("-INT")

	# Give them a moment to handle signals and close sockets
	time.sleep(SLEEP_SECONDS)

	# Anything still alive gets a TERM
	runPkill("-TERM")


#############################
if __name__ == "__main__":
	main()